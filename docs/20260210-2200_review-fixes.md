# 코드 리뷰 이슈 수정 완료
작성일: 2026-02-10

## 수정 완료 항목

### ✅ Blocking Issues

#### 1. Node에서 TS 파일 직접 import 문제
**문제:**
- `scripts/capture-image-queue.mjs`와 `scripts/capture-post-image.mjs`에서 `../src/lib/*.ts`를 import
- Node.js는 TypeScript를 직접 실행할 수 없음

**해결:**
- `tsx` 패키지 추가 (devDependencies)
- 스크립트를 `.mjs` → `.ts`로 변환
- package.json scripts를 `node`에서 `tsx`로 변경

**변경 파일:**
- ✅ `package.json` - tsx 추가
- ✅ `scripts/capture-image-queue.ts` (신규)
- ✅ `scripts/capture-post-image.ts` (신규)
- ✅ package.json scripts 수정

#### 2. 재시도 로직이 실제로 동작하지 않음
**문제:**
- `markJobAsFailed`가 status='failed'로 고정
- `getPendingJobs`는 status='pending'만 조회
- 실패한 작업이 자동으로 재시도되지 않음

**해결:**
- `markJobAsFailed` 수정: attempts < 3이면 status='pending'으로 되돌림
- attempts >= 3이면 status='failed'로 처리

**변경:**
```sql
-- 기존
UPDATE post_image_job
SET status = 'failed', attempts = attempts + 1, ...

-- 수정 후
UPDATE post_image_job
SET status = IF(attempts + 1 < 3, 'pending', 'failed'),
    attempts = attempts + 1, ...
```

**변경 파일:**
- ✅ `src/lib/image-job.ts` - `markJobAsFailed` 함수 수정

#### 3. 다중 워커에서 동일 작업 동시 처리 가능
**문제:**
- `getPendingJobs`가 락 없이 조회
- `markJobAsRunning`이 성공 여부 확인 없음
- 여러 워커가 동시에 같은 작업을 가져갈 수 있음

**해결:**
- `claimJobs()` 함수 추가 (원자적 작업 클레임)
- SELECT FOR UPDATE SKIP LOCKED 사용
- 트랜잭션으로 원자성 보장
- 워커에서 `claimJobs` 사용으로 변경

**구현:**
```typescript
export async function claimJobs(limit: number): Promise<ImageJob[]> {
  // 트랜잭션 시작
  await connection.beginTransaction();

  // SELECT FOR UPDATE SKIP LOCKED (다중 워커 안전)
  const [rows] = await connection.execute(
    `SELECT ... FROM post_image_job
     WHERE status = 'pending' AND attempts < 3
     ORDER BY created_at ASC
     LIMIT ?
     FOR UPDATE SKIP LOCKED`,
    [limit]
  );

  // 선택된 작업을 running으로 변경
  await connection.execute(
    `UPDATE post_image_job SET status = 'running' WHERE id IN (...)`,
    jobIds
  );

  await connection.commit();
  return jobs;
}
```

**변경 파일:**
- ✅ `src/lib/image-job.ts` - `claimJobs` 함수 추가
- ✅ `scripts/capture-image-queue.ts` - `claimJobs` 사용

### ✅ Medium Issues

#### 4. 캡처 워커 base URL 환경변수 불일치
**문제:**
- `src/lib/capture-post-image.ts`에서 `NEXT_PUBLIC_BASE_URL` 사용
- 프로젝트는 `NEXT_PUBLIC_SITE_URL` 중심

**해결:**
- `NEXT_PUBLIC_SITE_URL`로 통일

**변경 파일:**
- ✅ `src/lib/capture-post-image.ts`

#### 6. ETag가 없을 때 빈 문자열로 내려감
**문제:**
- `src/app/api/posts/[id]/image/route.ts`에서 `ETag: image.sha256 || ''`
- sha256이 null일 때 빈 문자열 반환

**해결:**
- sha256이 있을 때만 ETag 헤더 추가

**변경:**
```typescript
// 기존
headers: {
  'ETag': image.sha256 || '',
}

// 수정 후
const headers: Record<string, string> = { ... };
if (image.sha256) {
  headers['ETag'] = image.sha256;
}
```

**변경 파일:**
- ✅ `src/app/api/posts/[id]/image/route.ts`

### ⚠️ 미해결 이슈

#### 5. Playwright가 devDependencies에 있음
**현재 상태:**
- Playwright는 devDependencies에 위치
- 워커 환경에서 누락될 수 있음

**권장 해결 방안:**
1. 워커 환경에서 `npm install --include=dev` 실행
2. 또는 Playwright를 dependencies로 이동
3. 또는 별도 워커 서버에서 Playwright 직접 설치

**결정 보류:**
- 워커 배포 환경이 확정되지 않아 보류
- 배포 시 환경에 맞게 선택

#### 7. OG 캡처는 1200x630인데 렌더러 내부 해상도는 1024 고정
**현재 상태:**
- CanvasRenderer, ShaderRenderer에서 해상도가 1024x1024로 고정
- OG 이미지는 1200x630으로 캡처되므로 비율이 맞지 않을 수 있음

**권장 해결 방안:**
- 캡처 모드에서 `window.__CAPTURE_WIDTH__`, `window.__CAPTURE_HEIGHT__` 플래그 전달
- 렌더러가 이를 감지하여 해상도 조정

**결정 보류:**
- 현재도 동작하며, 심각한 문제는 아님
- 향후 개선 사항으로 추가

## 사용 방법 (수정 후)

### 설치
```bash
npm install
```

### 워커 실행
```bash
# 한 번만 실행
npm run capture:worker

# 계속 polling
npm run capture:worker:watch
```

### 수동 캡처
```bash
# 특정 post
npm run capture:post <post-id>

# 모든 post
npm run capture:all
```

## 테스트 체크리스트

### 필수 테스트
- [ ] tsx 설치 확인: `npx tsx --version`
- [ ] 워커 실행 테스트: `npm run capture:worker`
- [ ] DB 마이그레이션: `npm run db:migrate:jobs`
- [ ] 새 post 업로드 → job 생성 확인
- [ ] 워커 실행 → 이미지 생성 확인
- [ ] 다중 워커 동시 실행 → 중복 처리 없는지 확인

### 원자적 작업 클레임 테스트
```bash
# 터미널 1
npm run capture:worker:watch

# 터미널 2 (동시 실행)
npm run capture:worker:watch

# 확인: 각 워커가 다른 작업을 처리하는지 확인
```

### 재시도 로직 테스트
1. 캡처가 실패하는 post 생성 (예: 잘못된 코드)
2. 워커 실행 → 실패 확인
3. DB 확인:
   ```sql
   SELECT * FROM post_image_job WHERE post_id = '<post-id>';
   -- status='pending', attempts=1 (재시도 가능)
   ```
4. 워커 재실행 → 다시 시도 확인
5. 3회 실패 후 status='failed' 확인

## 파일 변경 요약

### 신규 생성
- `scripts/capture-image-queue.ts`
- `scripts/capture-post-image.ts`

### 수정
- `package.json` - tsx 추가, scripts 수정
- `src/lib/image-job.ts` - claimJobs 추가, markJobAsFailed 수정
- `src/lib/capture-post-image.ts` - NEXT_PUBLIC_SITE_URL 사용
- `src/app/api/posts/[id]/image/route.ts` - ETag 조건부 추가

### 삭제 (선택)
- `scripts/capture-image-queue.mjs` (더 이상 사용 안 함)
- `scripts/capture-post-image.mjs` (더 이상 사용 안 함)

## 배포 시 주의사항

### 워커 환경 설정
```bash
# Dockerfile 또는 배포 스크립트에서
npm install --include=dev  # tsx, playwright 포함

# 또는
npm install
npm install -g tsx

# 실행
tsx scripts/capture-image-queue.ts --watch
```

### 환경 변수
```bash
# 워커 환경에 필수
NEXT_PUBLIC_SITE_URL=https://your-domain.com
DB_HOST=your-db-host
DB_PORT=3306
DB_USERNAME=your-user
DB_PASSWORD=your-password
DB_DATABASE=your-database
```

## 남은 개선 사항

1. **테스트 코드 작성**
   - claimJobs 원자성 테스트
   - 재시도 로직 테스트
   - 다중 워커 동시 실행 테스트

2. **모니터링 추가**
   - 작업 실패율 메트릭
   - 평균 처리 시간
   - 큐 대기 시간

3. **캡처 품질 개선**
   - OG 이미지 해상도 최적화
   - 애니메이션 캡처 타이밍 개선

4. **에러 핸들링 강화**
   - 특정 에러 타입별 재시도 정책
   - Dead letter queue 구현
